- name: read current meta file
  slurp:
    src: /home/panupload/content/{{ item }}
  register: result

- set_fact:
    newfile: "{{ result['content'] | b64decode | trim }}"

- name: read old meta file
  slurp:
    src: /home/panupload/content/{{ item }}.old
  register: result

- set_fact:
    oldfile: "{{ result['content'] | b64decode | trim }}"

- name: upload the new file
  aws_s3:
    aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
    aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
    bucket: hagen-bootstrap-bckt
    object: /content/{{ newfile }}
    src: /home/panupload/content/{{ newfile }}
    mode: put
  when: newfile != oldfile

- name: delete the old file
  aws_s3:
    aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
    aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
    bucket: hagen-bootstrap-bckt
    object: /content/{{ oldfile }}
    mode: delobj
  when: newfile != oldfile

- name: delete the new file
  file: 
    path: /home/panupload/content/{{ newfile }}
    state: absent
  when: newfile != oldfile
  
- name: mark the file as processed
  copy:
    src: /home/panupload/content/{{ newfile }}
    dest: /home/panupload/content/{{ oldfile }}
    remote_src: yes
