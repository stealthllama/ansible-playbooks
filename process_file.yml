- name: copy meta file
  slurp:
    src: /home/panupload/content/{{ item }}
  register: result

- set_fact:
    newfile: "{{ result['content'] | b64decode | trim }}"

- name: fetch content file
  fetch:
    src: /home/panupload/content/{{ newfile }}
    dest: /tmp/
    flat: true

- name: upload to S3
  aws_s3:
    bucket: hagen-bootstrap-bckt
    object: /content/{{ newfile }}
    src: /tmp/{{ newfile }}
    mode: put
    ignore_nonexistent_bucket: True

- name: mark as processed
  copy:
    src: /home/panupload/content/{{ item }
    dest: /home/panupload/content/{{ item }.old
    remote_src: yes
